<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üçé Food Inventory Scanner</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #4CAF50, #81C784); color: white; padding: 20px; text-align: center; border-radius: 16px; margin-bottom: 20px; }
    #scanner-container.hidden { display: none; }
    #scanner-container { position: relative; height: 300px; background: #000; border-radius: 16px; overflow: hidden; margin: 20px 0; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
    #scanner { width: 100%; height: 100%; object-fit: cover; }
    .scanner-overlay { position: absolute; top: 20%; left: 20%; width: 60%; height: 60%; border: 3px solid #4CAF50; box-shadow: 0 0 30px #4CAF50; }
    .inventory-list { background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); max-height: 400px; overflow: auto; }
    .item { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #f0f0f0; transition: all 0.2s; }
    .item:hover { background: #f8f9fa; }
    .item:last-child { border-bottom: none; }
    .item-info { flex: 1; }
    .item-name { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
    .item-brand { color: #4CAF50; font-size: 14px; }
    .item-barcode { font-size: 12px; color: #666; font-family: monospace; }
    .item-quantity { font-size: 28px; font-weight: bold; min-width: 70px; text-align: center; color: #2196F3; }
    .btn { background: #2196F3; color: white; border: none; padding: 12px 24px; border-radius: 12px; font-size: 16px; cursor: pointer; margin: 4px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(33,150,243,0.3); }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(33,150,243,0.4); }
    .btn:active { transform: translateY(0); }
    .btn-success { background: #4CAF50; box-shadow: 0 4px 12px rgba(76,175,80,0.3); }
    .btn-danger { background: #f44336; box-shadow: 0 4px 12px rgba(244,67,54,0.3); }
    .btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
    .scan-result { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 16px 32px; border-radius: 50px; display: none; z-index: 1000; box-shadow: 0 8px 32px rgba(76,175,80,0.4); }
    .scan-result.loading { background: #FF9800; }
    .empty-state { text-align: center; padding: 60px 20px; color: #666; }
    .status { padding: 16px; background: linear-gradient(135deg, #e8f5e8, #f1f8e9); border-radius: 12px; margin-bottom: 20px; font-size: 15px; text-align: center; border-left: 4px solid #4CAF50; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin: 24px 0; }
    .loading { opacity: 0.6; pointer-events: none; }
    @media (max-width: 600px) { .container { padding: 12px; } .btn-group { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üçé Food Inventory</h1>
      <p>Scan groceries ‚Ä¢ Auto-lookup products ‚Ä¢ Track stock</p>
    </div>
    
    <div class="status" id="status">üëÜ Click START ‚Üí Scan any food product barcode</div>
    
    <div id="scanner-container" class="hidden">
      <video id="scanner" autoplay playsinline muted></video>
      <div class="scanner-overlay"></div>
    </div>
    
    <div class="btn-group">
      <button class="btn" id="startBtn" onclick="startScanner()">‚ñ∂Ô∏è START SCANNER</button>
      <button class="btn btn-danger" id="stopBtn" onclick="stopScanner()" disabled>‚èπÔ∏è STOP</button>
      <button class="btn" onclick="clearAll()">üóëÔ∏è CLEAR ALL</button>
      <button class="btn" onclick="exportData()">üíæ EXPORT CSV</button>
    </div>
    
    <div class="scan-result" id="scanResult">
      <span id="scanStatus">üîç Looking up product...</span>
      <span id="scanCode"></span>
    </div>
    
    <div class="inventory-list" id="inventoryList">
      <div class="empty-state">
        <h3>üì¶ No products yet</h3>
        <p>Scan any grocery product barcode (works with 2M+ foods worldwide)</p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <script>
    // Global state
    let inventory = JSON.parse(localStorage.getItem('foodInventory')) || [];
    let isScanning = false;
    let quagga = null;
    let scanCooldown = false;
    let broadcastChannel = null;
    let wsConnection = null;

    // üîÑ LIVE UPDATES: Broadcast Channel API (syncs between tabs/windows)
    function initBroadcastChannel() {
      try {
        broadcastChannel = new BroadcastChannel('food-inventory');
        broadcastChannel.onmessage = (event) => {
          const { type, data } = event.data;
          if (type === 'inventory-update') {
            inventory = data;
            renderInventory();
            updateStatus('üîÑ Synced with other tab');
            setTimeout(() => updateStatus('Ready! Works with real grocery products'), 2000);
          }
        };
        console.log('‚úÖ Broadcast Channel ready - tabs will sync automatically');
      } catch (error) {
        console.log('Broadcast Channel not supported');
      }
    }

    // üåê LIVE UPDATES: WebSocket connection (cross-device sync)
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const host = window.location.host;  // Includes hostname:port
      
      try {
        wsConnection = new WebSocket(`${protocol}//${host}`);
        
        wsConnection.onopen = () => {
          console.log('‚úÖ Connected to sync server');
          updateStatus('üîó Connected to live sync');
          // Send current inventory to server
          wsConnection.send(JSON.stringify({ type: 'sync', data: inventory }));
        };
        
        wsConnection.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);
            if (message.type === 'update') {
              inventory = message.data;
              localStorage.setItem('foodInventory', JSON.stringify(inventory));
              renderInventory();
              // Broadcast to other tabs
              if (broadcastChannel) {
                broadcastChannel.postMessage({ type: 'inventory-update', data: inventory });
              }
              updateStatus('üîÑ Synced from another device');
              setTimeout(() => updateStatus('Ready! Works with real grocery products'), 2000);
            }
          } catch (e) {
            console.log('Invalid message format');
          }
        };
        
        wsConnection.onerror = () => {
          console.log('‚ö†Ô∏è Sync server unavailable (local mode only)');
        };
        
        wsConnection.onclose = () => {
          console.log('Disconnected - retrying in 5s');
          setTimeout(connectWebSocket, 5000);
        };
      } catch (error) {
        console.log('WebSocket not available');
      }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      initBroadcastChannel();
      connectWebSocket();
      renderInventory();
      updateStatus('Ready! Works with real grocery products (Open Food Facts 2M+ database)');
    });

    // Food product lookup API (FREE - Open Food Facts)
    async function lookupProduct(barcode) {
      try {
        const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
        const data = await response.json();
        
        if (data.status === 1 && data.product) {
          const product = data.product;
          return {
            name: product.product_name || `Food Product ${barcode.slice(-6)}`,
            brand: product.brands || '',
            ingredients: product.ingredients_text || '',
            image: product.image_url || '',
            nutrition: product.nutrition_grades || 'N/A'
          };
        }
      } catch (error) {
        console.log('API lookup failed, using generic name');
      }
      
      // Fallback
      return {
        name: `Food Item ${barcode.slice(-6)}`,
        brand: '',
        ingredients: '',
        image: '',
        nutrition: 'N/A'
      };
    }

    function startScanner() {
      if (isScanning) return;
      
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      
      startBtn.disabled = true;
      stopBtn.disabled = false;
      updateStatus('üöÄ Starting camera...');
      
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#scanner-container'),
          constraints: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: "environment"
          }
        },
        locator: { halfSample: true, patchSize: "medium" },
        numOfWorkers: 1,
        frequency: 10,
        decoder: {
          readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader", "code_39_reader"]
        },
        locate: true
      }, function(err) {
        if (err) {
          updateStatus('‚ùå Camera error. Try mobile browser.');
          startBtn.disabled = false;
          stopBtn.disabled = true;
          return;
        }
        
        document.getElementById('scanner-container').classList.remove('hidden');
        Quagga.start();
        isScanning = true;
        quagga = Quagga;
        updateStatus('‚úÖ Scanner ready! Point at grocery barcode');
      });
    }

    function stopScanner() {
      if (quagga) quagga.stop();
      isScanning = false;
      document.getElementById('scanner-container').classList.add('hidden');
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      updateStatus('‚èπÔ∏è Scanner stopped');
    }

    // Barcode detection + API lookup
    Quagga.onDetected(async function(result) {
      if (!isScanning || scanCooldown) return;
      
      const code = result.codeResult.code;
      if (!code || code.length < 8) return;
      
      scanCooldown = true;
      setTimeout(() => scanCooldown = false, 3000);
      
      // Show loading
      showScanResult('üîç Looking up ' + code);
      
      // Lookup product
      const productInfo = await lookupProduct(code);
      
      // Update inventory
      let existing = inventory.find(item => item.barcode === code);
      if (existing) {
        existing.quantity += 1;
        existing.lastUpdated = Date.now();
      } else {
        inventory.push({
          barcode: code,
          name: productInfo.name,
          brand: productInfo.brand,
          quantity: 1,
          lastUpdated: Date.now(),
          nutrition: productInfo.nutrition
        });
      }
      
      saveInventory();
      renderInventory();
      showScanResult(`‚úÖ ${productInfo.name}`);
    });

    function renderInventory() {
      const list = document.getElementById('inventoryList');
      if (inventory.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <h3>üì¶ No products yet</h3>
            <p>Scan grocery barcodes from Open Food Facts (2M+ products)</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = inventory
        .sort((a, b) => b.lastUpdated - a.lastUpdated)
        .map(item => `
          <div class="item">
            <div class="item-info">
              <div class="item-name">${item.name}</div>
              ${item.brand ? `<div class="item-brand">${item.brand}</div>` : ''}
              <div class="item-barcode">${item.barcode}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <button class="btn btn-danger" onclick="updateQuantity('${item.barcode}', -1)">‚àí</button>
              <div class="item-quantity">${item.quantity}</div>
              <button class="btn btn-success" onclick="updateQuantity('${item.barcode}', 1)">+</button>
            </div>
          </div>
        `).join('');
    }

    function updateQuantity(barcode, delta) {
      const item = inventory.find(item => item.barcode === barcode);
      if (item) {
        item.quantity = Math.max(0, item.quantity + delta);
        if (item.quantity === 0) {
          inventory = inventory.filter(i => i.barcode !== barcode);
        } else {
          item.lastUpdated = Date.now();
        }
        saveInventory();
        renderInventory();
      }
    }

    function clearAll() {
      if (confirm('Delete all products?')) {
        inventory = [];
        saveInventory();
        renderInventory();
        updateStatus('üóëÔ∏è Cleared all products');
      }
    }

    function showScanResult(message) {
      const result = document.getElementById('scanResult');
      document.getElementById('scanStatus').textContent = message;
      result.style.display = 'block';
      setTimeout(() => result.style.display = 'none', 3000);
    }

    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }

    function saveInventory() {
      localStorage.setItem('foodInventory', JSON.stringify(inventory));
      
      // üîÑ Broadcast to other tabs
      if (broadcastChannel) {
        broadcastChannel.postMessage({ type: 'inventory-update', data: inventory });
      }
      
      // üåê Send to WebSocket server
      if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {
        wsConnection.send(JSON.stringify({ type: 'update', data: inventory }));
      }
    }

    function exportData() {
      if (inventory.length === 0) return alert('No products!');
      const csv = ['Barcode,Product,Brand,Quantity,Nutrition\n']
        .concat(inventory.map(item => 
          `"${item.barcode}","${item.name.replace(/"/g,'""')}","${item.brand.replace(/"/g,'""')}",${item.quantity},"${item.nutrition}"`
        )).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `food-inventory-${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
    }
  </script>
</body>
</html>
